var $conTextMenu="",_noop=function(){};Object.keys||(Object.keys=function(){"use strict";var o=Object.prototype.hasOwnProperty,a=!{toString:null}.propertyIsEnumerable("toString"),s=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=s.length;return function(e){if("object"!=typeof e&&("function"!=typeof e||null===e))throw new TypeError("Object.keys called on non-object");var t,i,n=[];for(t in e)o.call(e,t)&&n.push(t);if(a)for(i=0;i<d;i++)o.call(e,s[i])&&n.push(s[i]);return n}}()),$(function(){$("body").append('<div id="kmsjsmap_contextmenu"><ul class="kmsjsmap-dropdown-menu"><li><a href="javascript: kmsjsmap.add_node();">添加节点</a></li><li><a href="javascript: kmsjsmap.modify_node()">编辑节点</a></li><li><a href="javascript: kmsjsmap.del_node()">删除节点</a></li><li><a href="javascript: kmsjsmap.relation_node()">关联节点</a></li></ul></div>'),$conTextMenu=$("div#kmsjsmap_contextmenu")}),function(r){"use strict";var e="jsMind",i="0.4.6",v="undefined"==typeof console?{log:_noop,debug:_noop,error:_noop,warn:_noop,info:_noop}:console;if(v.debug||(v.debug=_noop),"undefined"!=typeof module&&module.exports||void 0===r[e]){var l=r.document,h=function(e){return l.createElement(e)},_=function(e,t){e.hasChildNodes()?e.firstChild.nodeValue=t:e.appendChild(l.createTextNode(t))},s=function(e,t){e.innerHTML=t};"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(e){return this.slice(0,e.length)===e});var n={container:"",editable:!1,theme:null,mode:"full",support_html:!0,view:{hmargin:100,vmargin:50,line_width:2,line_color:"#555"},layout:{hspace:30,vspace:20,pspace:13},default_event_handle:{enable_mousedown_handle:!0,enable_click_handle:!0,enable_dblclick_handle:!0},shortcut:{enable:!0,handles:{},mapping:{addchild:45,addbrother:13,editnode:113,delnode:46,toggle:32,left:37,up:38,right:39,down:40}}},p=function(e){(p.current=this).version=i;var t={};p.util.json.merge(t,n),p.util.json.merge(t,e),t.container?(this.options=t,this.inited=!1,this.mind=null,this.event_handles=[],this.init()):v.error("the options.container should not be null or empty.")};p.direction={left:-1,center:0,right:1},p.event_type={show:1,resize:2,edit:3,select:4},p.node=function(e,t,i,n,o,a,s,d){e?"number"==typeof t?(void 0===d&&(d=!0),this.id=e,this.index=t,this.topic=i,this.data=n||{},this.isroot=o,this.parent=a,this.direction=s,this.expanded=!!d,this.children=[],this._data={}):v.error("invalid node index"):v.error("invalid nodeid")},p.node.compare=function(e,t){var i=e.index,n=t.index;return 0<=i&&0<=n?i-n:-1==i&&-1==n?0:-1==i?1:-1==n?-1:0},p.node.inherited=function(e,t){if(e&&t){if(e.id===t.id)return!0;if(e.isroot)return!0;for(var i=e.id,n=t;!n.isroot;)if((n=n.parent).id===i)return!0}return!1},p.node.prototype={get_location:function(){var e=this._data.view;return{x:e.abs_x,y:e.abs_y}},get_size:function(){var e=this._data.view;return{w:e.width,h:e.height}}},p.mind=function(){this.name=null,this.author=null,this.version=null,this.root=null,this.selected=null,this.nodes={}},p.mind.prototype={get_node:function(e){return e in this.nodes?this.nodes[e]:(v.warn("the node[id="+e+"] can not be found"),null)},set_root:function(e,t,i){null==this.root?(this.root=new p.node(e,0,t,i,!0),this._put_node(this.root)):v.error("root node is already exist")},add_node:function(e,t,i,n,o,a,s){if(!p.util.is_node(e)){var d=this.get_node(e);return d?this.add_node(d,t,i,n,o,a,s):(v.error("the parent_node[id="+e+"] can not be found."),null)}var r=o||-1,l=null;if(e.isroot){var h=p.direction.right;if(!a||isNaN(a)){for(var _=e.children,u=_.length,c=0,f=0;f<u;f++)_[f].direction===p.direction.left?c--:c++;h=1<u&&0<c?p.direction.left:p.direction.right}else h=a!=p.direction.left?p.direction.right:p.direction.left;l=new p.node(t,r,i,n,!1,e,h,s)}else l=new p.node(t,r,i,n,!1,e,e.direction,s);return this._put_node(l)?(e.children.push(l),this._reindex(e)):(v.error("fail, the nodeid '"+l.id+"' has been already exist."),l=null),l},insert_node_before:function(e,t,i,n){if(!p.util.is_node(e)){var o=this.get_node(e);return o?this.insert_node_before(o,t,i,n):(v.error("the node_before[id="+e+"] can not be found."),null)}var a=e.index-.5;return this.add_node(e.parent,t,i,n,a)},get_node_before:function(e){if(!p.util.is_node(e)){var t=this.get_node(e);return t?this.get_node_before(t):(v.error("the node[id="+e+"] can not be found."),null)}if(e.isroot)return null;var i=e.index-2;return 0<=i?e.parent.children[i]:null},insert_node_after:function(e,t,i,n){if(!p.util.is_node(e)){var o=this.get_node(node_before);return o?this.insert_node_after(o,t,i,n):(v.error("the node_after[id="+e+"] can not be found."),null)}var a=e.index+.5;return this.add_node(e.parent,t,i,n,a)},get_node_after:function(e){if(!p.util.is_node(e)){var t=this.get_node(e);return t?this.get_node_after(t):(v.error("the node[id="+e+"] can not be found."),null)}if(e.isroot)return null;var i=e.index;return e.parent.children.length>=i?e.parent.children[i]:null},move_node:function(e,t,i,n){if(!p.util.is_node(e)){var o=this.get_node(e);return o?this.move_node(o,t,i,n):(v.error("the node[id="+e+"] can not be found."),null)}return i||(i=e.parent.id),this._move_node(e,t,i,n)},_flow_node_direction:function(e,t){void 0===t?t=e.direction:e.direction=t;for(var i=e.children.length;i--;)this._flow_node_direction(e.children[i],t)},_move_node_internal:function(e,t){if(e&&t)if("_last_"==t)e.index=-1,this._reindex(e.parent);else if("_first_"==t)e.index=0,this._reindex(e.parent);else{var i=t?this.get_node(t):null;null!=i&&null!=i.parent&&i.parent.id==e.parent.id&&(e.index=i.index-.5,this._reindex(e.parent))}return e},_move_node:function(e,t,i,n){if(e&&i){if(e.parent.id!=i){for(var o=e.parent.children,a=o.length;a--;)if(o[a].id==e.id){o.splice(a,1);break}e.parent=this.get_node(i),e.parent.children.push(e)}e.parent.isroot?n==jsMind.direction.left?e.direction=n:e.direction=p.direction.right:e.direction=e.parent.direction,this._move_node_internal(e,t),this._flow_node_direction(e)}return e},remove_node:function(e){if(!p.util.is_node(e)){var t=this.get_node(e);return t?this.remove_node(t):(v.error("the node[id="+e+"] can not be found."),!1)}if(!e)return v.error("fail, the node can not be found"),!1;if(e.isroot)return v.error("fail, can not remove root node"),!1;$('div.leo-badge[nodeid$="'+e.id+'"]').remove(),null!=this.selected&&this.selected.id==e.id&&(this.selected=null);for(var i=e.children,n=i.length;n--;)this.remove_node(i[n]);i.length=0;for(var o=e.parent.children,a=o.length;a--;)if(o[a].id==e.id){o.splice(a,1);break}for(var s in delete this.nodes[e.id],e)delete e[s];return!(e=null)},_put_node:function(e){return e.id in this.nodes?(v.warn("the nodeid '"+e.id+"' has been already exist."),!1):(this.nodes[e.id]=e,!0)},_reindex:function(e){if(e instanceof p.node){e.children.sort(p.node.compare);for(var t=0;t<e.children.length;t++)e.children[t].index=t+1}}},p.format={node_tree:{example:{meta:{name:e,version:i},format:"node_tree",data:{id:"root",topic:"jsMind Example"}},get_mind:function(e){var t=p.format.node_tree,i=new p.mind;return i.name=e.meta.name,i.author=e.meta.author,i.version=e.meta.version,t._parse(i,e.data),i},get_data:function(e){var t=p.format.node_tree,i={};return i.meta={name:e.name,author:e.author,version:e.version},i.format="node_tree",i.data=t._buildnode(e.root),i},_parse:function(e,t){var i=p.format.node_tree,n=i._extract_data(t);if(e.set_root(t.id,t.topic,n),"children"in t)for(var o=t.children,a=0;a<o.length;a++)i._extract_subnode(e,e.root,o[a])},_extract_data:function(e){var t={};for(var i in e)"id"!=i&&"topic"!=i&&"children"!=i&&"direction"!=i&&"expanded"!=i&&(t[i]=e[i]);return t},_extract_subnode:function(e,t,i){var n=p.format.node_tree,o=n._extract_data(i),a=null;t.isroot&&(a="left"==i.direction?p.direction.left:p.direction.right);var s=e.add_node(t,i.id,i.topic,o,null,a,i.expanded);if("children"in i)for(var d=i.children,r=0;r<d.length;r++)n._extract_subnode(e,s,d[r])},_buildnode:function(e){var t=p.format.node_tree;if(e instanceof p.node){var i={id:e.id,topic:e.topic,expanded:e.expanded};if(e.parent&&e.parent.isroot&&(i.direction=e.direction==p.direction.left?"left":"right"),null!=e.data){var n=e.data;for(var o in n)i[o]=n[o]}var a=e.children;if(0<a.length){i.children=[];for(var s=0;s<a.length;s++)i.children.push(t._buildnode(a[s]))}return i}}},node_array:{example:{meta:{name:e,version:i},format:"node_array",data:[{id:"root",topic:"jsMind Example",isroot:!0}]},get_mind:function(e){var t=p.format.node_array,i=new p.mind;return i.name=e.meta.name,i.author=e.meta.author,i.version=e.meta.version,t._parse(i,e.data),i},get_data:function(e){var t=p.format.node_array,i={};return i.meta={name:e.name,author:e.author,version:e.version},i.format="node_array",i.data=[],t._array(e,i.data),i},_parse:function(e,t){var i=p.format.node_array,n=t.slice(0);n.reverse();var o=i._extract_root(e,n);o?i._extract_subnode(e,o,n):v.error("root node can not be found")},_extract_root:function(e,t){for(var i=p.format.node_array,n=t.length;n--;)if("isroot"in t[n]&&t[n].isroot){var o=t[n],a=i._extract_data(o);return e.set_root(o.id,o.topic,a),t.splice(n,1),o.id}return null},_extract_subnode:function(e,t,i){for(var n=p.format.node_array,o=i.length,a=null,s=null,d=0;o--;)if((a=i[o]).parentid==t){s=n._extract_data(a);var r=null,l=a.direction;l&&(r="left"==l?p.direction.left:p.direction.right),e.add_node(t,a.id,a.topic,s,null,r,a.expanded),i.splice(o,1),d++;var h=n._extract_subnode(e,a.id,i);0<h&&(o=i.length,d+=h)}return d},_extract_data:function(e){var t={};for(var i in e)"id"!=i&&"topic"!=i&&"parentid"!=i&&"isroot"!=i&&"direction"!=i&&"expanded"!=i&&(t[i]=e[i]);return t},_array:function(e,t){p.format.node_array._array_node(e.root,t)},_array_node:function(e,t){var i=p.format.node_array;if(e instanceof p.node){var n={id:e.id,topic:e.topic,expanded:e.expanded};if(e.parent&&(n.parentid=e.parent.id),e.isroot&&(n.isroot=!0),e.parent&&e.parent.isroot&&(n.direction=e.direction==p.direction.left?"left":"right"),null!=e.data){var o=e.data;for(var a in o)n[a]=o[a]}t.push(n);for(var s=e.children.length,d=0;d<s;d++)i._array_node(e.children[d],t)}}},freemind:{example:{meta:{name:e,version:i},format:"freemind",data:'<map version="1.0.1"><node ID="root" TEXT="freemind Example"/></map>'},get_mind:function(e){var t=p.format.freemind,i=new p.mind;i.name=e.meta.name,i.author=e.meta.author,i.version=e.meta.version;var n=e.data,o=t._parse_xml(n),a=t._find_root(o);return t._load_node(i,null,a),i},get_data:function(e){var t=p.format.freemind,i={};i.meta={name:e.name,author:e.author,version:e.version},i.format="freemind";var n=[];return n.push('<map version="1.0.1">'),t._buildmap(e.root,n),n.push("</map>"),i.data=n.join(" "),i},_parse_xml:function(e){var t=null;window.DOMParser?t=(new DOMParser).parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async=!1,t.loadXML(e));return t},_find_root:function(e){for(var t=e.childNodes,i=null,n=null,o=0;o<t.length;o++)if(1==(n=t[o]).nodeType&&"map"==n.tagName){i=n;break}if(i){var a=i.childNodes;i=null;for(o=0;o<a.length;o++)if(1==(n=a[o]).nodeType&&"node"==n.tagName){i=n;break}}return i},_load_node:function(e,t,i){var n=p.format.freemind,o=i.getAttribute("ID"),a=i.getAttribute("TEXT");if(null==a)for(var s=i.childNodes,d=null,r=0;r<s.length;r++)if(1==(d=s[r]).nodeType&&"richcontent"===d.tagName){a=d.textContent;break}var l=n._load_attributes(i),h=!("expanded"in l)||"true"==l.expanded;delete l.expanded;var _=i.getAttribute("POSITION"),u=null;_&&(u="left"==_?p.direction.left:p.direction.right),t?e.add_node(t,o,a,l,null,u,h):e.set_root(o,a,l);var c=i.childNodes,f=null;for(r=0;r<c.length;r++)1==(f=c[r]).nodeType&&"node"==f.tagName&&n._load_node(e,o,f)},_load_attributes:function(e){for(var t=e.childNodes,i=null,n={},o=0;o<t.length;o++)1==(i=t[o]).nodeType&&"attribute"===i.tagName&&(n[i.getAttribute("NAME")]=i.getAttribute("VALUE"));return n},_buildmap:function(e,t){var i=p.format.freemind,n=null;e.parent&&e.parent.isroot&&(n=e.direction===p.direction.left?"left":"right"),t.push("<node"),t.push('ID="'+e.id+'"'),n&&t.push('POSITION="'+n+'"'),t.push('TEXT="'+e.topic+'">'),t.push('<attribute NAME="expanded" VALUE="'+e.expanded+'"/>');var o=e.data;if(null!=o)for(var a in o)t.push('<attribute NAME="'+a+'" VALUE="'+o[a]+'"/>');for(var s=e.children,d=0;d<s.length;d++)i._buildmap(s[d],t);t.push("</node>")}}},p.util={is_node:function(e){return!!e&&e instanceof p.node},ajax:{_xhr:function(){var e=null;if(window.XMLHttpRequest)e=new XMLHttpRequest;else try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}return e},_eurl:function(e){return encodeURIComponent(e)},request:function(e,t,i,n,o){var a=p.util.ajax,s=null,d=[];for(var r in t)d.push(a._eurl(r)+"="+a._eurl(t[r]));0<d.length&&(s=d.join("&"));var l=a._xhr();l&&(l.onreadystatechange=function(){if(4==l.readyState)if(200==l.status||0==l.status){if("function"==typeof n){var e=p.util.json.string2json(l.responseText);n(null!=e?e:l.responseText)}}else"function"==typeof o?o(l):v.error("xhr request failed.",l)},i=i||"GET",l.open(i,e,!0),l.setRequestHeader("If-Modified-Since","0"),"POST"==i?(l.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),l.send(s)):l.send())},get:function(e,t){return p.util.ajax.request(e,{},"GET",t)},post:function(e,t,i){return p.util.ajax.request(e,t,"POST",i)}},dom:{add_event:function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent("on"+t,i)}},canvas:{bezierto:function(e,t,i,n,o){e.beginPath(),e.moveTo(t,i),e.bezierCurveTo(t+2*(n-t)/3,i,t,o,n,o),e.stroke()},lineto:function(e,t,i,n,o){e.beginPath(),e.moveTo(t,i),e.lineTo(n,o),e.stroke()},clear:function(e,t,i,n,o){e.clearRect(t,i,n,o)}},file:{read:function(e,t){var i=new FileReader;i.onload=function(){"function"==typeof t&&t(this.result,e.name)},i.readAsText(e)},save:function(e,t,i){var n;if("function"==typeof r.Blob)n=new Blob([e],{type:t});else{var o=new(r.BlobBuilder||r.MozBlobBuilder||r.WebKitBlobBuilder||r.MSBlobBuilder);o.append(e),n=o.getBlob(t)}if(navigator.msSaveBlob)navigator.msSaveBlob(n,i);else{var a=(r.URL||r.webkitURL).createObjectURL(n),s=h("a");if("download"in s){s.style.visibility="hidden",s.href=a,s.download=i,l.body.appendChild(s);var d=l.createEvent("MouseEvents");d.initEvent("click",!0,!0),s.dispatchEvent(d),l.body.removeChild(s)}else location.href=a}}},json:{json2string:function(e){if(JSON)try{return JSON.stringify(e)}catch(e){return v.warn(e),v.warn("can not convert to string"),null}},string2json:function(e){if(JSON)try{return JSON.parse(e)}catch(e){return v.warn(e),v.warn("can not parse to json"),null}},merge:function(e,t){for(var i in t)i in e?"object"!=typeof e[i]||"[object object]"!=Object.prototype.toString.call(e[i]).toLowerCase()||e[i].length?e[i]=t[i]:p.util.json.merge(e[i],t[i]):e[i]=t[i];return e}},uuid:{newid:function(){return((new Date).getTime().toString(16)+Math.random().toString(16).substr(2)).substr(2,16)}},text:{is_empty:function(e){return!e||0==e.replace(/\s*/,"").length}}},p.prototype={init:function(){if(!this.inited){this.inited=!0;var e=this.options,t={mode:e.mode,hspace:e.layout.hspace,vspace:e.layout.vspace,pspace:e.layout.pspace},i={container:e.container,support_html:e.support_html,hmargin:e.view.hmargin,vmargin:e.view.vmargin,line_width:e.view.line_width,line_color:e.view.line_color};this.data=new p.data_provider(this),this.layout=new p.layout_provider(this,t),this.view=new p.view_provider(this,i),this.shortcut=new p.shortcut_provider(this,e.shortcut),this.data.init(),this.layout.init(),this.view.init(),this.shortcut.init(),this._event_bind(),p.init_plugins(this)}},enable_edit:function(){this.options.editable=!0},disable_edit:function(){this.options.editable=!1},enable_event_handle:function(e){this.options.default_event_handle["enable_"+e+"_handle"]=!0},disable_event_handle:function(e){this.options.default_event_handle["enable_"+e+"_handle"]=!1},get_editable:function(){return this.options.editable},set_theme:function(e){var t=this.options.theme;this.options.theme=e||null,t!=this.options.theme&&(this.view.reset_theme(),this.view.reset_custom_style())},_event_bind:function(){this.view.add_event(this,"mousedown",this.mousedown_handle),this.view.add_event(this,"click",this.click_handle),this.view.add_event(this,"dblclick",this.dblclick_handle)},mousedown_handle:function(e){if(this.options.default_event_handle.enable_mousedown_handle){var t=e.target||event.srcElement,i=this.view.get_binded_nodeid(t);i?this.select_node(i):this.select_clear()}},click_handle:function(e){if(this.options.default_event_handle.enable_click_handle){var t=e.target||event.srcElement;if(this.view.is_expander(t))if(i=this.view.get_binded_nodeid(t))return void this.toggle_node(i);if(!this.get_editable()){var i,n=this.options.onRelation;if(!n)return;(i=this.view.get_binded_nodeid(t))&&n(this.mind.selected)}}},dblclick_handle:function(e){if(this.options.default_event_handle.enable_dblclick_handle&&this.get_editable()){var t=e.target||event.srcElement,i=this.view.get_binded_nodeid(t);i&&this.begin_edit(i)}},begin_edit:function(e){if(!p.util.is_node(e)){var t=this.get_node(e);return t?this.begin_edit(t):(v.error("the node[id="+e+"] can not be found."),!1)}this.get_editable()?this.view.edit_node_begin(e):v.error("fail, this mind map is not editable.")},end_edit:function(){this.view.edit_node_end()},toggle_node:function(e){if(!p.util.is_node(e)){var t=this.get_node(e);return t?this.toggle_node(t):void v.error("the node[id="+e+"] can not be found.")}e.isroot||(this.view.save_location(e),this.layout.toggle_node(e),this.view.relayout(),this.view.restore_location(e))},expand_node:function(e){if(!p.util.is_node(e)){var t=this.get_node(e);return t?this.expand_node(t):void v.error("the node[id="+e+"] can not be found.")}e.isroot||(this.view.save_location(e),this.layout.expand_node(e),this.view.relayout(),this.view.restore_location(e))},collapse_node:function(e){if(!p.util.is_node(e)){var t=this.get_node(e);return t?this.collapse_node(t):void v.error("the node[id="+e+"] can not be found.")}e.isroot||(this.view.save_location(e),this.layout.collapse_node(e),this.view.relayout(),this.view.restore_location(e))},expand_all:function(){this.layout.expand_all(),this.view.relayout()},collapse_all:function(){this.layout.collapse_all(),this.view.relayout()},expand_to_depth:function(e){this.layout.expand_to_depth(e),this.view.relayout()},_reset:function(){this.view.reset(),this.layout.reset(),this.data.reset()},_show:function(e){var t=e||p.format.node_array.example;this.mind=this.data.load(t),this.mind?(v.debug("data.load ok"),this.view.load(),v.debug("view.load ok"),this.layout.layout(),v.debug("layout.layout ok"),this.view.show(!0),v.debug("view.show ok"),this.invoke_event_handle(p.event_type.show,{data:[e]})):v.error("data.load error")},show:function(e){this._reset(),this._show(e)},get_meta:function(){return{name:this.mind.name,author:this.mind.author,version:this.mind.version}},get_data:function(e){var t=e||"node_tree";return this.data.get_data(t)},get_root:function(){return this.mind.root},get_node:function(e){return this.mind.get_node(e)},add_node:function(e,t,i,n){if(this.get_editable()){var o=this.mind.add_node(e,t,i,n);return o&&(this.view.add_node(o),this.layout.layout(),this.view.show(!1),this.view.reset_node_custom_style(o),this.expand_node(e),this.invoke_event_handle(p.event_type.edit,{evt:"add_node",data:[e.id,t,i,n],node:t})),o}return v.error("fail, this mind map is not editable"),null},insert_node_before:function(e,t,i,n){if(this.get_editable()){var o=p.util.is_node(e)?e.id:e,a=this.mind.insert_node_before(e,t,i,n);return a&&(this.view.add_node(a),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(p.event_type.edit,{evt:"insert_node_before",data:[o,t,i,n],node:t})),a}return v.error("fail, this mind map is not editable"),null},insert_node_after:function(e,t,i,n){if(this.get_editable()){var o=p.util.is_node(e)?e.id:e,a=this.mind.insert_node_after(e,t,i,n);return a&&(this.view.add_node(a),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(p.event_type.edit,{evt:"insert_node_after",data:[o,t,i,n],node:t})),a}return v.error("fail, this mind map is not editable"),null},remove_node:function(e){if(!p.util.is_node(e)){var t=this.get_node(e);return t?this.remove_node(t):(v.error("the node[id="+e+"] can not be found."),!1)}if(this.get_editable()){if(e.isroot)return v.error("fail, can not remove root node"),!1;var i=e.id,n=e.parent.id,o=this.get_node(n);return this.view.save_location(o),this.view.remove_node(e),this.mind.remove_node(e),this.layout.layout(),this.view.show(!1),this.view.restore_location(o),this.invoke_event_handle(p.event_type.edit,{evt:"remove_node",data:[i],node:n}),!0}return v.error("fail, this mind map is not editable"),!1},update_node:function(e,t){if(this.get_editable())if(p.util.text.is_empty(t))v.warn("fail, topic can not be empty");else{var i=this.get_node(e);if(i){if(i.topic===t)return v.info("nothing changed"),void this.view.update_node(i);i.topic=t,this.view.update_node(i),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(p.event_type.edit,{evt:"update_node",data:[e,t],node:e})}}else v.error("fail, this mind map is not editable")},move_node:function(e,t,i,n){if(this.get_editable()){var o=this.mind.move_node(e,t,i,n);o&&(this.view.update_node(o),this.layout.layout(),this.view.show(!1),this.invoke_event_handle(p.event_type.edit,{evt:"move_node",data:[e,t,i,n],node:e}))}else v.error("fail, this mind map is not editable")},select_node:function(e){if(!p.util.is_node(e)){var t=this.get_node(e);return t?this.select_node(t):void v.error("the node[id="+e+"] can not be found.")}this.layout.is_visible(e)&&(this.mind.selected=e,this.view.select_node(e))},get_selected_node:function(){return this.mind?this.mind.selected:null},select_clear:function(){this.mind&&(this.mind.selected=null,this.view.select_clear())},is_node_visible:function(e){return this.layout.is_visible(e)},find_node_before:function(e){if(!p.util.is_node(e)){var t=this.get_node(e);return t?this.find_node_before(t):void v.error("the node[id="+e+"] can not be found.")}if(e.isroot)return null;var i=null;if(e.parent.isroot)for(var n=e.parent.children,o=null,a=null,s=0;s<n.length;s++)a=n[s],e.direction===a.direction&&(e.id===a.id&&(i=o),o=a);else i=this.mind.get_node_before(e);return i},find_node_after:function(e){if(!p.util.is_node(e)){var t=this.get_node(e);return t?this.find_node_after(t):void v.error("the node[id="+e+"] can not be found.")}if(e.isroot)return null;var i=null;if(e.parent.isroot){for(var n=e.parent.children,o=!1,a=null,s=0;s<n.length;s++)if(a=n[s],e.direction===a.direction){if(o){i=a;break}e.id===a.id&&(o=!0)}}else i=this.mind.get_node_after(e);return i},set_node_color:function(e,t,i){if(!this.get_editable())return v.error("fail, this mind map is not editable"),null;var n=this.mind.get_node(e);n&&(t&&(n.data["background-color"]=t),i&&(n.data["foreground-color"]=i),this.view.reset_node_custom_style(n))},set_node_font_style:function(e,t,i,n){if(!this.get_editable())return v.error("fail, this mind map is not editable"),null;var o=this.mind.get_node(e);o&&(t&&(o.data["font-size"]=t),i&&(o.data["font-weight"]=i),n&&(o.data["font-style"]=n),this.view.reset_node_custom_style(o),this.view.update_node(o),this.layout.layout(),this.view.show(!1))},set_node_background_image:function(e,t,i,n,o){if(!this.get_editable())return v.error("fail, this mind map is not editable"),null;var a=this.mind.get_node(e);a&&(t&&(a.data["background-image"]=t),i&&(a.data.width=i),n&&(a.data.height=n),o&&(a.data["background-rotation"]=o),this.view.reset_node_custom_style(a),this.view.update_node(a),this.layout.layout(),this.view.show(!1))},set_node_background_rotation:function(e,t){if(!this.get_editable())return v.error("fail, this mind map is not editable"),null;var i=this.mind.get_node(e);if(i){if(!i.data["background-image"])return v.error("fail, only can change rotation angle of node with background image"),null;i.data["background-rotation"]=t,this.view.reset_node_custom_style(i),this.view.update_node(i),this.layout.layout(),this.view.show(!1)}},resize:function(){this.view.resize()},add_event_listener:function(e){"function"==typeof e&&this.event_handles.push(e)},invoke_event_handle:function(e,t){var i=this;r.setTimeout(function(){i._invoke_event_handle(e,t)},0)},_invoke_event_handle:function(e,t){for(var i=this.event_handles.length,n=0;n<i;n++)this.event_handles[n](e,t)}},p.data_provider=function(e){this.jm=e},p.data_provider.prototype={init:function(){v.debug("data.init")},reset:function(){v.debug("data.reset")},load:function(e){var t=null,i=null;return"node_array"==(t="object"==typeof e?e.format?e.format:"node_tree":"freemind")?i=p.format.node_array.get_mind(e):"node_tree"==t?i=p.format.node_tree.get_mind(e):"freemind"==t?i=p.format.freemind.get_mind(e):v.warn("unsupported format"),i},get_data:function(e){var t=null;return"node_array"==e?t=p.format.node_array.get_data(this.jm.mind):"node_tree"==e?t=p.format.node_tree.get_data(this.jm.mind):"freemind"==e?t=p.format.freemind.get_data(this.jm.mind):v.error("unsupported "+e+" format"),t}},p.layout_provider=function(e,t){this.opts=t,this.jm=e,this.isside="side"==this.opts.mode,this.bounds=null,this.cache_valid=!1},p.layout_provider.prototype={init:function(){v.debug("layout.init")},reset:function(){v.debug("layout.reset"),this.bounds={n:0,s:0,w:0,e:0}},layout:function(){v.debug("layout.layout"),this.layout_direction(),this.layout_offset()},layout_direction:function(){this._layout_direction_root()},_layout_direction_root:function(){var e=this.jm.mind.root,t=null;"layout"in e._data?t=e._data.layout:(t={},e._data.layout=t);var i=e.children,n=i.length;if(t.direction=p.direction.center,t.side_index=0,this.isside)for(var o=n;o--;)this._layout_direction_side(i[o],p.direction.right,o);else{o=n;for(var a=null;o--;)(a=i[o]).direction==p.direction.left?this._layout_direction_side(a,p.direction.left,o):this._layout_direction_side(a,p.direction.right,o)}},_layout_direction_side:function(e,t,i){var n=null;"layout"in e._data?n=e._data.layout:(n={},e._data.layout=n);var o=e.children,a=o.length;n.direction=t,n.side_index=i;for(var s=a;s--;)this._layout_direction_side(o[s],t,s)},layout_offset:function(){var e=this.jm.mind.root,t=e._data.layout;t.offset_x=0,t.offset_y=0,t.outer_height=0;for(var i=e.children,n=i.length,o=[],a=[],s=null;n--;)(s=i[n])._data.layout.direction==p.direction.right?a.unshift(s):o.unshift(s);t.left_nodes=o,t.right_nodes=a,t.outer_height_left=this._layout_offset_subnodes(o),t.outer_height_right=this._layout_offset_subnodes(a),this.bounds.e=e._data.view.width/2,this.bounds.w=0-this.bounds.e,this.bounds.n=0,this.bounds.s=Math.max(t.outer_height_left,t.outer_height_right)},_layout_offset_subnodes:function(e){for(var t=0,i=e.length,n=i,o=null,a=0,s=null,d=0,r=null;n--;)s=(o=e[n])._data.layout,null==r&&(r=o.parent._data),a=this._layout_offset_subnodes(o.children),o.expanded||(a=0,this.set_visible(o.children,!1)),a=Math.max(o._data.view.height,a),s.outer_height=a,s.offset_y=d-a/2,s.offset_x=this.opts.hspace*s.direction+r.view.width*(r.layout.direction+s.direction)/2,o.parent.isroot||(s.offset_x+=this.opts.pspace*s.direction),d=d-a-this.opts.vspace,t+=a;1<i&&(t+=this.opts.vspace*(i-1)),n=i;for(var l=t/2;n--;)(o=e[n])._data.layout.offset_y+=l;return t},_layout_offset_subnodes_height:function(e){for(var t=0,i=e.length,n=i,o=null,a=0,s=null,d=0,r=null;n--;)s=(o=e[n])._data.layout,null==r&&(r=o.parent._data),a=this._layout_offset_subnodes_height(o.children),o.expanded||(a=0),a=Math.max(o._data.view.height,a),s.outer_height=a,s.offset_y=d-a/2,d=d-a-this.opts.vspace,t+=a;1<i&&(t+=this.opts.vspace*(i-1)),n=i;for(var l=t/2;n--;)(o=e[n])._data.layout.offset_y+=l;return t},get_node_offset:function(e){var t=e._data.layout,i=null;if("_offset_"in t&&this.cache_valid?i=t._offset_:(i={x:-1,y:-1},t._offset_=i),-1==i.x||-1==i.y){var n=t.offset_x,o=t.offset_y;if(!e.isroot){var a=this.get_node_offset(e.parent);n+=a.x,o+=a.y}i.x=n,i.y=o}return i},get_node_point:function(e){var t=e._data.view,i=this.get_node_offset(e),n={};return n.x=i.x+t.width*(e._data.layout.direction-1)/2,n.y=i.y-t.height/2,n},get_node_point_in:function(e){return this.get_node_offset(e)},get_node_point_out:function(e){var t=e._data.layout,i=null;if("_pout_"in t&&this.cache_valid?i=t._pout_:(i={x:-1,y:-1},t._pout_=i),-1==i.x||-1==i.y)if(e.isroot)i.x=0,i.y=0;else{var n=e._data.view,o=this.get_node_offset(e);i.x=o.x+(n.width+this.opts.pspace)*e._data.layout.direction,i.y=o.y}return i},get_expander_point:function(e){var t=this.get_node_point_out(e),i={};return e._data.layout.direction==p.direction.right?i.x=t.x-this.opts.pspace:i.x=t.x,i.y=t.y-Math.ceil(this.opts.pspace/2),i},get_min_size:function(){var e=this.jm.mind.nodes,t=null,i=null;for(var n in e)(t=e[n]).parent&&!t.parent.expanded||((i=this.get_node_point_out(t)).x>this.bounds.e&&(this.bounds.e=i.x),i.x<this.bounds.w&&(this.bounds.w=i.x));return{w:this.bounds.e-this.bounds.w,h:this.bounds.s-this.bounds.n}},toggle_node:function(e){e.isroot||(e.expanded?this.collapse_node(e):this.expand_node(e))},expand_node:function(e){e.expanded=!0,this.part_layout(e),this.set_visible(e.children,!0),this.toggleBadge(e.children,!0)},collapse_node:function(e){e.expanded=!1,this.part_layout(e),this.set_visible(e.children,!1),this.toggleBadge(e.children,!1)},toggleBadge:function(e,i){var n=this;e.forEach(function(e){if(!0===n.jm.is_node_visible(e))return!0;n.toggleBadge(e.children,i);var t=$('div.leo-badge[nodeid$="'+e.id+'"]');!0===i?t.show():t.hide()})},expand_all:function(){var e,t=this.jm.mind.nodes,i=0;for(var n in t)(e=t[n]).expanded||(e.expanded=!0,i++);if(0<i){var o=this.jm.mind.root;this.part_layout(o),this.set_visible(o.children,!0)}},collapse_all:function(){var e,t=this.jm.mind.nodes,i=0;for(var n in t)(e=t[n]).expanded&&!e.isroot&&(e.expanded=!1,i++);if(0<i){var o=this.jm.mind.root;this.part_layout(o),this.set_visible(o.children,!0)}},expand_to_depth:function(e,t,i){if(!(e<1))for(var n=t||this.jm.mind.root.children,o=i||1,a=n.length,s=null;a--;)s=n[a],o<e&&(s.expanded||this.expand_node(s),this.expand_to_depth(e,s.children,o+1)),o==e&&s.expanded&&this.collapse_node(s)},part_layout:function(e){var t=this.jm.mind.root;if(t){var i=t._data.layout;e.isroot?(i.outer_height_right=this._layout_offset_subnodes_height(i.right_nodes),i.outer_height_left=this._layout_offset_subnodes_height(i.left_nodes)):e._data.layout.direction==p.direction.right?i.outer_height_right=this._layout_offset_subnodes_height(i.right_nodes):i.outer_height_left=this._layout_offset_subnodes_height(i.left_nodes),this.bounds.s=Math.max(i.outer_height_left,i.outer_height_right),this.cache_valid=!1}else v.warn("can not found root node")},set_visible:function(e,t){for(var i=e.length,n=null;i--;)(n=e[i])._data.layout,n.expanded?this.set_visible(n.children,t):this.set_visible(n.children,!1),n.isroot||(n._data.layout.visible=t)},is_expand:function(e){return e.expanded},is_visible:function(e){var t=e._data.layout;return!("visible"in t&&!t.visible)}},p.view_provider=function(e,t){this.opts=t,this.jm=e,this.layout=e.layout,this.container=null,this.e_panel=null,this.e_nodes=null,this.e_canvas=null,this.canvas_ctx=null,this.size={w:0,h:0},this.selected_node=null,this.editing_node=null},p.view_provider.prototype={init:function(){var e,t;if(v.debug("view.init"),this.container=(t=this.opts.container)&&"object"==typeof t&&1===t.nodeType&&"object"==typeof t.style&&"object"==typeof t.ownerDocument?this.opts.container:(e=this.opts.container,l.getElementById(e)),this.container){this.e_panel=h("div"),this.e_canvas=h("canvas"),this.e_nodes=h("jmnodes"),this.e_editor=h("input"),this.e_panel.className="jsmind-inner",this.e_panel.appendChild(this.e_canvas),this.e_panel.appendChild(this.e_nodes),this.e_editor.className="jsmind-editor",this.e_editor.type="text",this.actualZoom=1,this.zoomStep=.1,this.minZoom=.5,this.maxZoom=2;var i=this;p.util.dom.add_event(this.e_editor,"keydown",function(e){var t=e||event;13==t.keyCode&&(i.edit_node_end(),t.stopPropagation())}),p.util.dom.add_event(this.e_editor,"blur",function(e){i.edit_node_end()}),this.container.appendChild(this.e_panel),this.init_canvas()}else v.error("the options.view.container was not be found in dom")},add_event:function(i,e,n){p.util.dom.add_event(this.e_nodes,e,function(e){var t=e||event;n.call(i,t)})},get_binded_nodeid:function(e){if(null==e)return null;var t=e.tagName.toLowerCase();return"jmnodes"==t||"body"==t||"html"==t?null:"jmnode"==t||"jmexpander"==t?e.getAttribute("nodeid"):this.get_binded_nodeid(e.parentElement)},is_expander:function(e){return"jmexpander"==e.tagName.toLowerCase()},reset:function(){v.debug("view.reset"),this.selected_node=null,this.clear_lines(),this.clear_nodes(),this.reset_theme()},reset_theme:function(){var e=this.jm.options.theme;this.e_nodes.className=e?"theme-"+e:""},reset_custom_style:function(){var e=this.jm.mind.nodes;for(var t in e)this.reset_node_custom_style(e[t])},load:function(){v.debug("view.load"),this.init_nodes()},expand_size:function(){var e=this.layout.get_min_size(),t=e.w+2*this.opts.hmargin,i=e.h+2*this.opts.vmargin,n=this.e_panel.clientWidth,o=this.e_panel.clientHeight;n<t&&(n=t),o<i&&(o=i),this.size.w=n,this.size.h=o},init_canvas:function(){var e=this.e_canvas.getContext("2d");this.canvas_ctx=e},init_nodes_size:function(e){var t=e._data.view;t.width=t.element.clientWidth,t.height=t.element.clientHeight},init_nodes:function(){var e=this.jm.mind.nodes,t=l.createDocumentFragment();for(var i in e)this.create_node_element(e[i],t);for(var i in this.e_nodes.appendChild(t),e)this.init_nodes_size(e[i])},add_node:function(e){this.create_node_element(e,this.e_nodes),this.init_nodes_size(e)},create_node_element:function(e,t){var i=null;"view"in e._data?i=e._data.view:(i={},e._data.view=i);var n=h("jmnode");if(e.isroot)n.className="root";else{var o=h("jmexpander");_(o,"-"),o.setAttribute("nodeid",e.id),o.style.visibility="hidden",t.appendChild(o),i.expander=o}e.topic&&(this.opts.support_html?s(n,e.topic):_(n,e.topic));var a=h("div");a.className="leo-badge",t.appendChild(a),_(a,e._data.badge),a.setAttribute("nodeid",e.id),a.style.visibility="hidden",i.badge=a,n.setAttribute("nodeid",e.id),n.style.visibility="hidden",!0===e.data.isLink?$(n).addClass("isLink"):$(n).removeClass("isLink"),this._reset_node_custom_style(n,e.data),t.appendChild(n),i.element=n},remove_node:function(e){null!=this.selected_node&&this.selected_node.id==e.id&&(this.selected_node=null),null!=this.editing_node&&this.editing_node.id==e.id&&(e._data.view.element.removeChild(this.e_editor),this.editing_node=null);for(var t=e.children,i=t.length;i--;)this.remove_node(t[i]);if(e._data.view){var n=e._data.view.element,o=e._data.view.expander;this.e_nodes.removeChild(n),this.e_nodes.removeChild(o),e._data.view.element=null,e._data.view.expander=null}},update_node:function(e){var t=e._data.view,i=t.element;e.topic&&(this.opts.support_html?s(i,e.topic):_(i,e.topic)),t.width=i.clientWidth,t.height=i.clientHeight},select_node:function(e){this.selected_node&&(this.selected_node._data.view.element.className=this.selected_node._data.view.element.className.replace(/\s*selected\b/i,""),this.reset_node_custom_style(this.selected_node)),e&&((this.selected_node=e)._data.view.element.className+=" selected",this.clear_node_custom_style(e))},select_clear:function(){this.select_node(null)},get_editing_node:function(){return this.editing_node},is_editing:function(){return!!this.editing_node},edit_node_begin:function(e){if(e.topic){null!=this.editing_node&&this.edit_node_end();var t=(this.editing_node=e)._data.view.element,i=e.topic,n=getComputedStyle(t);this.e_editor.value=i,this.e_editor.style.width=t.clientWidth-parseInt(n.getPropertyValue("padding-left"))-parseInt(n.getPropertyValue("padding-right"))+"px",t.innerHTML="",t.appendChild(this.e_editor),t.style.zIndex=5,this.e_editor.focus(),this.e_editor.select()}else v.warn("don't edit image nodes")},edit_node_end:function(){if(null!=this.editing_node){var e=this.editing_node;this.editing_node=null;var t=e._data.view.element,i=this.e_editor.value;t.style.zIndex="auto",t.removeChild(this.e_editor),p.util.text.is_empty(i)||e.topic===i?this.opts.support_html?s(t,e.topic):_(t,e.topic):this.jm.update_node(e.id,i)}},get_view_offset:function(){var e=this.layout.bounds;return{x:(this.size.w-e.e-e.w)/2,y:this.size.h/2}},resize:function(){this.e_canvas.width=1,this.e_canvas.height=1,this.e_nodes.style.width="1px",this.e_nodes.style.height="1px",this.expand_size(),this._show()},_show:function(){this.e_canvas.width=this.size.w,this.e_canvas.height=this.size.h,this.e_nodes.style.width=this.size.w+"px",this.e_nodes.style.height=this.size.h+"px",this.show_nodes(),this.show_lines(),this.jm.invoke_event_handle(p.event_type.resize,{data:[]})},zoomIn:function(){return this.setZoom(this.actualZoom+this.zoomStep)},zoomOut:function(){return this.setZoom(this.actualZoom-this.zoomStep)},setZoom:function(e){if(e<this.minZoom||e>this.maxZoom)return!1;this.actualZoom=e;for(var t=0;t<this.e_panel.children.length;t++)this.e_panel.children[t].style.transform="scale("+e+")",this.e_panel.children[t].style["-ms-transform"]="scale("+e+")";return this.show(!0),!0},_center_root:function(){var e=this.e_panel.clientWidth,t=this.e_panel.clientHeight;if(this.size.w>e){var i=this.get_view_offset();this.e_panel.scrollLeft=i.x-e/2}this.size.h>t&&(this.e_panel.scrollTop=(this.size.h-t)/2)},show:function(e){v.debug("view.show"),this.expand_size(),this._show(),e&&this._center_root()},relayout:function(){this.expand_size(),this._show()},save_location:function(e){var t=e._data.view;t._saved_location={x:parseInt(t.element.style.left)-this.e_panel.scrollLeft,y:parseInt(t.element.style.top)-this.e_panel.scrollTop}},restore_location:function(e){var t=e._data.view;this.e_panel.scrollLeft=parseInt(t.element.style.left)-t._saved_location.x,this.e_panel.scrollTop=parseInt(t.element.style.top)-t._saved_location.y},clear_nodes:function(){var e=this.jm.mind;if(null!=e){var t=e.nodes,i=null;for(var n in t)(i=t[n])._data.view.element=null,i._data.view.expander=null;this.e_nodes.innerHTML=""}},show_nodes:function(){var e=this.jm.mind.nodes,t=null,i=null,n=null,o=null,a=null,s="-",d=null,r=this.get_view_offset();for(var l in e)if(i=(d=(t=e[l])._data.view).element,n=d.expander,this.layout.is_visible(t)){if(this.reset_node_custom_style(t),o=this.layout.get_node_point(t),d.abs_x=r.x+o.x,d.abs_y=r.y+o.y,i.style.left=r.x+o.x+"px",i.style.top=r.y+o.y+"px",i.style.display="",i.style.visibility="visible",a=this.layout.get_expander_point(t),!t.isroot&&0<t.children.length&&(s=t.expanded?"-":"+",n.style.left=r.x+a.x+"px",n.style.top=r.y+a.y+"px",n.style.display="",n.style.visibility="visible",_(n,s)),t.isroot||0!=t.children.length||(n.style.display="none",n.style.visibility="hidden"),t.data.badge&&!(t.data.badge<1)){var h=d.badge;h.style.left=r.x+a.x-10+"px",h.style.top=r.y+a.y-20+"px",h.style.display="",h.style.visibility="visible",_(h,t.data.badge)}}else i.style.display="none",n.style.display="none"},reset_node_custom_style:function(e){this._reset_node_custom_style(e._data.view.element,e.data)},_reset_node_custom_style:function(i,e){if("background-color"in e&&(i.style.backgroundColor=e["background-color"]),"foreground-color"in e&&(i.style.color=e["foreground-color"]),"width"in e&&(i.style.width=e.width+"px"),"height"in e&&(i.style.height=e.height+"px"),"font-size"in e&&(i.style.fontSize=e["font-size"]+"px"),"font-weight"in e&&(i.style.fontWeight=e["font-weight"]),"font-style"in e&&(i.style.fontStyle=e["font-style"]),"background-image"in e){var t=e["background-image"];if(t.startsWith("data")&&e.width&&e.height){var n=new Image;n.onload=function(){var e=h("canvas");e.width=i.clientWidth,e.height=i.clientHeight;if(e.getContext){e.getContext("2d").drawImage(this,2,2,i.clientWidth,i.clientHeight);var t=e.toDataURL();i.style.backgroundImage="url("+t+")"}},n.src=t}else i.style.backgroundImage="url("+t+")";i.style.backgroundSize="99%","background-rotation"in e&&(i.style.transform="rotate("+e["background-rotation"]+"deg)")}},clear_node_custom_style:function(e){var t=e._data.view.element;t.style.backgroundColor="",t.style.color=""},clear_lines:function(e){var t=e||this.canvas_ctx;p.util.canvas.clear(t,0,0,this.size.w,this.size.h)},show_lines:function(e){this.clear_lines(e);var t=this.jm.mind.nodes,i=null,n=null,o=null,a=this.get_view_offset();for(var s in t)(i=t[s]).isroot||"visible"in i._data.layout&&!i._data.layout.visible||(n=this.layout.get_node_point_in(i),o=this.layout.get_node_point_out(i.parent),this.draw_line(o,n,a,e))},draw_line:function(e,t,i,n){var o=n||this.canvas_ctx;o.strokeStyle=this.opts.line_color,o.lineWidth=this.opts.line_width,o.lineCap="round",p.util.canvas.bezierto(o,e.x+i.x,e.y+i.y,t.x+i.x,t.y+i.y)}},p.shortcut_provider=function(e,t){this.jm=e,this.opts=t,this.mapping=t.mapping,this.handles=t.handles,this._mapping={}},p.shortcut_provider.prototype={init:function(){for(var e in p.util.dom.add_event(l,"keydown",this.handler.bind(this)),this.handles.addchild=this.handle_addchild,this.handles.addbrother=this.handle_addbrother,this.handles.editnode=this.handle_editnode,this.handles.delnode=this.handle_delnode,this.handles.toggle=this.handle_toggle,this.handles.up=this.handle_up,this.handles.down=this.handle_down,this.handles.left=this.handle_left,this.handles.right=this.handle_right,this.mapping)this.mapping[e]&&e in this.handles&&(this._mapping[this.mapping[e]]=this.handles[e])},enable_shortcut:function(){this.opts.enable=!0},disable_shortcut:function(){this.opts.enable=!1},handler:function(e){if(!this.jm.view.is_editing()){var t=e||event;if(!this.opts.enable)return!0;var i=t.keyCode;i in this._mapping&&this._mapping[i].call(this,this.jm,e)}},handle_addchild:function(e,t){var i=e.get_selected_node();if(i){var n=p.util.uuid.newid();e.add_node(i,n,"New Node")&&(e.select_node(n),e.begin_edit(n))}},handle_addbrother:function(e,t){var i=e.get_selected_node();if(i&&!i.isroot){var n=p.util.uuid.newid();e.insert_node_after(i,n,"New Node")&&(e.select_node(n),e.begin_edit(n))}},handle_editnode:function(e,t){var i=e.get_selected_node();i&&e.begin_edit(i)},handle_delnode:function(e,t){var i=e.get_selected_node();i&&!i.isroot&&(e.select_node(i.parent),e.remove_node(i))},handle_toggle:function(e,t){var i=t||event,n=e.get_selected_node();n&&(e.toggle_node(n.id),i.stopPropagation(),i.preventDefault())},handle_up:function(e,t){var i=t||event,n=e.get_selected_node();if(n){var o=e.find_node_before(n);if(!o){var a=e.find_node_before(n.parent);a&&0<a.children.length&&(o=a.children[a.children.length-1])}o&&e.select_node(o),i.stopPropagation(),i.preventDefault()}},handle_down:function(e,t){var i=t||event,n=e.get_selected_node();if(n){var o=e.find_node_after(n);if(!o){var a=e.find_node_after(n.parent);a&&0<a.children.length&&(o=a.children[0])}o&&e.select_node(o),i.stopPropagation(),i.preventDefault()}},handle_left:function(e,t){this._handle_direction(e,t,p.direction.left)},handle_right:function(e,t){this._handle_direction(e,t,p.direction.right)},_handle_direction:function(e,t,i){var n=t||event,o=e.get_selected_node(),a=null;if(o){if(o.isroot){for(var s=o.children,d=[],r=0;r<s.length;r++)s[r].direction===i&&d.push(r);a=s[d[Math.floor((d.length-1)/2)]]}else if(o.direction===i){var l=(d=o.children).length;0<l&&(a=d[Math.floor((l-1)/2)])}else a=o.parent;a&&e.select_node(a),n.stopPropagation(),n.preventDefault()}}},p.plugin=function(e,t){this.name=e,this.init=t},p.plugins=[],p.register_plugin=function(e){e instanceof p.plugin&&p.plugins.push(e)},p.init_plugins=function(e){r.setTimeout(function(){p._init_plugins(e)},0)},p._init_plugins=function(e){for(var t=p.plugins.length,i=null,n=0;n<t;n++)"function"==typeof(i=p.plugins[n].init)&&i(e)},p.show=function(e,t){var i=new p(e);return i.show(t),i},r[e]=p}else v.log(e+" has been already exist.")}(window),function(s){"use strict";var i=s.document,x=s.jsMind;if(x&&void 0===x.draggable){var t=x.util.dom,n=x.util.canvas,o="getSelection"in s?function(){s.getSelection().removeAllRanges()}:function(){i.selection.empty()},j=5,d=500,r=80;x.draggable=function(e){this.jm=e,this.e_canvas=null,this.canvas_ctx=null,this.shadow=null,this.shadow_w=0,this.shadow_h=0,this.active_node=null,this.target_node=null,this.target_direct=null,this.client_w=0,this.client_h=0,this.offset_x=0,this.offset_y=0,this.hlookup_delay=0,this.hlookup_timer=0,this.capture=!1,this.moved=!1},x.draggable.prototype={init:function(){this._create_canvas(),this._create_shadow(),this._event_bind()},resize:function(){this.jm.view.e_nodes.appendChild(this.shadow),this.e_canvas.width=this.jm.view.size.w,this.e_canvas.height=this.jm.view.size.h},_create_canvas:function(){var e=i.createElement("canvas");this.jm.view.e_panel.appendChild(e);var t=e.getContext("2d");this.e_canvas=e,this.canvas_ctx=t},_create_shadow:function(){var e=i.createElement("jmnode");e.style.visibility="hidden",e.style.zIndex="3",e.style.cursor="move",e.style.opacity="0.7",this.shadow=e},reset_shadow:function(e){var t=this.shadow.style;this.shadow.innerHTML=e.innerHTML,t.left=e.style.left,t.top=e.style.top,t.width=e.style.width,t.height=e.style.height,t.backgroundImage=e.style.backgroundImage,t.backgroundSize=e.style.backgroundSize,t.transform=e.style.transform,this.shadow_w=this.shadow.clientWidth,this.shadow_h=this.shadow.clientHeight},show_shadow:function(){this.moved||(this.shadow.style.visibility="visible")},hide_shadow:function(){this.shadow.style.visibility="hidden"},clear_lines:function(){n.clear(this.canvas_ctx,0,0,this.jm.view.size.w,this.jm.view.size.h)},_magnet_shadow:function(e){e&&(this.canvas_ctx.lineWidth=j,this.canvas_ctx.strokeStyle="rgba(0,0,0,0.3)",this.canvas_ctx.lineCap="round",this.clear_lines(),n.lineto(this.canvas_ctx,e.sp.x,e.sp.y,e.np.x,e.np.y))},_lookup_close_node:function(){var e,t,i=this.jm.get_root(),n=i.get_location(),o=i.get_size(),a=n.x+o.w/2,s=this.shadow_w,d=this.shadow_h,r=this.shadow.offsetLeft,l=this.shadow.offsetTop,h=a<=r+s/2?x.direction.right:x.direction.left,_=this.jm.mind.nodes,u=null,c=Number.MAX_VALUE,f=0,v=null,p=null,m=null;for(var g in _){var y,w;if((u=_[g]).isroot||u.direction==h){if(u.id==this.active_node.id)continue;if(e=u.get_size(),t=u.get_location(),h==x.direction.right){if(r-t.x-e.w<=0)continue;f=Math.abs(r-t.x-e.w)+Math.abs(l+d/2-t.y-e.h/2),y={x:t.x+e.w-j,y:t.y+e.h/2},w={x:r+j,y:l+d/2}}else{if(t.x-r-s<=0)continue;f=Math.abs(r+s-t.x)+Math.abs(l+d/2-t.y-e.h/2),y={x:t.x+j,y:t.y+e.h/2},w={x:r+s-j,y:l+d/2}}f<c&&(v=u,p=y,m=w,c=f)}}var b=null;return v&&(b={node:v,direction:h,sp:m,np:p}),b},lookup_close_node:function(){var e=this._lookup_close_node();e&&(this._magnet_shadow(e),this.target_node=e.node,this.target_direct=e.direction)},_event_bind:function(){var i=this,e=this.jm.view.container;t.add_event(e,"contextmenu",function(e){var t=e||event;i.dragend.call(i,t)}),t.add_event(e,"mousedown",function(e){$conTextMenu.hide();var t=e||event;i.dragstart.call(i,t)}),t.add_event(e,"mousemove",function(e){var t=e||event;i.drag.call(i,t)}),t.add_event(e,"mouseup",function(e){var t=e||event;i.dragend.call(i,t)}),t.add_event(e,"touchstart",function(e){var t=e||event;i.dragstart.call(i,t)}),t.add_event(e,"touchmove",function(e){var t=e||event;i.drag.call(i,t)}),t.add_event(e,"touchend",function(e){var t=e||event;i.dragend.call(i,t)})},dragstart:function(e){if(this.jm.get_editable()&&!this.capture){this.active_node=null;var t=this.jm.view,i=e.target||event.srcElement;if("jmnode"==i.tagName.toLowerCase()){var n=t.get_binded_nodeid(i);if(n){var o=this.jm.get_node(n);if(!o.isroot){this.reset_shadow(i),this.active_node=o,this.offset_x=(e.clientX||e.touches[0].clientX)-i.offsetLeft,this.offset_y=(e.clientY||e.touches[0].clientY)-i.offsetTop,this.client_hw=Math.floor(i.clientWidth/2),this.client_hh=Math.floor(i.clientHeight/2),0!=this.hlookup_delay&&s.clearTimeout(this.hlookup_delay),0!=this.hlookup_timer&&s.clearInterval(this.hlookup_timer);var a=this;this.hlookup_delay=s.setTimeout(function(){a.hlookup_delay=0,a.hlookup_timer=s.setInterval(function(){a.lookup_close_node.call(a)},r)},d),this.capture=!0}}}}},drag:function(e){if(this.jm.get_editable()&&this.capture){e.preventDefault(),this.show_shadow(),this.moved=!0,o();var t=(e.clientX||e.touches[0].clientX)-this.offset_x,i=(e.clientY||e.touches[0].clientY)-this.offset_y;this.client_hw,this.client_hh;this.shadow.style.left=t+"px",this.shadow.style.top=i+"px",o()}},dragend:function(e){if(this.jm.get_editable()){if(this.capture){if(0!=this.hlookup_delay&&(s.clearTimeout(this.hlookup_delay),this.hlookup_delay=0,this.clear_lines()),0!=this.hlookup_timer&&(s.clearInterval(this.hlookup_timer),this.hlookup_timer=0,this.clear_lines()),this.moved){var t=this.active_node,i=this.target_node,n=this.target_direct;this.move_node(t,i,n)}this.hide_shadow()}this.moved=!1,this.capture=!1}},move_node:function(e,t,i){var n=this.shadow.offsetTop;if(t&&e&&!x.node.inherited(e,t)){for(var o=t.children,a=o.length,s=null,d=Number.MAX_VALUE,r=null,l="_last_";a--;)if((s=o[a]).direction==i&&s.id!=e.id){var h=s.get_location().y-n;0<h&&h<d&&(d=h,r=s,l="_first_")}r&&(l=r.id),this.jm.move_node(e.id,l,t.id,i)}this.active_node=null,this.target_node=null,this.target_direct=null},jm_event_handle:function(e,t){e===x.event_type.resize&&this.resize()}};var e=new x.plugin("draggable",function(e){var i=new x.draggable(e);i.init(),e.add_event_listener(function(e,t){i.jm_event_handle.call(i,e,t)})});x.register_plugin(e)}}(window),function(s){"use strict";var n=s.jsMind;if(n&&void 0===n.screenshot){var d=s.document,r=function(e){return d.createElement(e)},y=function(e,t){return e.getPropertyValue(t)},w=function(e){var t=y(e,"visibility"),i=y(e,"display");return"hidden"!==t&&"none"!==i},b=n.util.canvas;b.rect=function(e,t,i,n,o,a){n<2*a&&(a=n/2),o<2*a&&(a=o/2),e.moveTo(t+a,i),e.arcTo(t+n,i,t+n,i+o,a),e.arcTo(t+n,i+o,t,i+o,a),e.arcTo(t,i+o,t,i,a),e.arcTo(t,i,t+n,i,a)},b.text_multiline=function(e,t,i,n,o,a,s){var d="",r=t.length,l=t.split(""),h=null;e.textAlign="left",e.textBaseline="top";for(var _=0;_<r;_++)h=d+l[_],e.measureText(h).width>o&&0<_?(e.fillText(d,i,n),d=l[_],n+=s):d=h;e.fillText(d,i,n)},b.text_ellipsis=function(e,t,i,n,o,a){var s=n+a/2;t=b.fittingString(e,t,o);e.textAlign="left",e.textBaseline="middle",e.fillText(t,i,s,o)},b.fittingString=function(e,t,i){var n=e.measureText(t).width,o=e.measureText("…").width;if(n<=i||n<=o)return t;for(var a=t.length;i-o<=n&&0<a--;)t=t.substring(0,a),n=e.measureText(t).width;return t+"…"},b.image=function(e,t,i,n,o,a,s,d,r){var l=new Image;l.onload=function(){e.save(),e.translate(i,n),e.save(),e.beginPath(),b.rect(e,0,0,o,a,s),e.closePath(),e.clip(),e.translate(o/2,a/2),e.rotate(d*Math.PI/180),e.drawImage(l,-o/2,-a/2),e.restore(),e.restore(),r()},l.src=t},n.screenshot=function(e){this.jm=e,this.canvas_elem=null,this.canvas_ctx=null,this._inited=!1},n.screenshot.prototype={init:function(){if(!this._inited){var e=r("canvas"),t=e.getContext("2d");this.canvas_elem=e,this.canvas_ctx=t,this.jm.view.e_panel.appendChild(e),this._inited=!0,this.resize()}},shoot:function(e){this.init(),this._watermark();var t=this;this._draw(function(){e&&e(t),t.clean()})},shootDownload:function(){this.shoot(function(e){e._download()})},shootAsDataURL:function(t){this.shoot(function(e){t(e.canvas_elem.toDataURL())})},resize:function(){this._inited&&(this.canvas_elem.width=this.jm.view.size.w,this.canvas_elem.height=this.jm.view.size.h)},clean:function(){var e=this.canvas_elem;this.canvas_ctx.clearRect(0,0,e.width,e.height)},_draw:function(e){var t=this.canvas_ctx;t.textAlign="left",t.textBaseline="top",this._draw_lines(),this._draw_nodes(e)},_watermark:function(){var e=this.canvas_elem,t=this.canvas_ctx;t.textAlign="right",t.textBaseline="bottom",t.fillStyle="#000",t.font="11px Verdana,Arial,Helvetica,sans-serif",t.fillText("hizzgdev.github.io/jsmind",e.width-5.5,e.height-2.5),t.textAlign="left",t.fillText(s.location,5.5,e.height-2.5)},_draw_lines:function(){this.jm.view.show_lines(this.canvas_ctx)},_draw_nodes:function(n){var o,a=this.jm.mind.nodes;for(var e in a)o=a[e],this._draw_node(o);!function e(){var t=!0;for(var i in a)t&=(o=a[i]).ready;t?s.setTimeout(n,200):s.setTimeout(e,200)}()},_draw_node:function(e){var t=this.canvas_ctx,i=e._data.view,n=i.element,o=getComputedStyle(n);if(w(o)){var a=y(o,"background-color"),s=parseInt(y(o,"border-top-left-radius")),d=y(o,"color"),r=parseInt(y(o,"padding-left")),l=parseInt(y(o,"padding-right")),h=parseInt(y(o,"padding-top")),_=parseInt(y(o,"padding-bottom")),u=y(o,"text-overflow"),c=y(o,"font-style")+" "+y(o,"font-variant")+" "+y(o,"font-weight")+" "+y(o,"font-size")+"/"+y(o,"line-height")+" "+y(o,"font-family"),f={x:i.abs_x,y:i.abs_y,w:i.width+1,h:i.height+1},v={x:f.x+r,y:f.y+h,w:f.w-r-l,h:f.h-h-_};if(t.font=c,t.fillStyle=a,t.beginPath(),b.rect(t,f.x,f.y,f.w,f.h,s),t.closePath(),t.fill(),t.fillStyle=d,"background-image"in e.data){var p=y(o,"background-image").slice(5,-2);e.ready=!1;var m=0;"background-rotation"in e.data&&(m=e.data["background-rotation"]),b.image(t,p,f.x,f.y,f.w,f.h,s,m,function(){e.ready=!0})}if(e.topic)if("ellipsis"===u)b.text_ellipsis(t,e.topic,v.x,v.y,v.w,v.h);else{var g=parseInt(y(o,"line-height"));b.text_multiline(t,e.topic,v.x,v.y,v.w,v.h,g)}i.expander&&this._draw_expander(i.expander),"background-image"in e.data||(e.ready=!0)}else e.ready=!0},_draw_expander:function(e){var t=this.canvas_ctx,i=getComputedStyle(e);if(w(i)){var n=y(i,"left"),o=y(i,"top"),a=(y(i,"font"),parseInt(n)),s=parseInt(o),d="+"===e.innerHTML;t.lineWidth=1,t.beginPath(),t.arc(a+7,s+7,5,0,2*Math.PI,!0),t.moveTo(a+10,s+7),t.lineTo(a+4,s+7),d&&(t.moveTo(a+7,s+4),t.lineTo(a+7,s+10)),t.closePath(),t.stroke()}},_download:function(){var e=this.canvas_elem,t=this.jm.mind.name+".png";if(navigator.msSaveBlob&&e.msToBlob){var i=e.msToBlob();navigator.msSaveBlob(i,t)}else{var n=this.canvas_elem.toDataURL(),o=r("a");if("download"in o){o.style.visibility="hidden",o.href=n,o.download=t,d.body.appendChild(o);var a=d.createEvent("MouseEvents");a.initEvent("click",!0,!0),o.dispatchEvent(a),d.body.removeChild(o)}else location.href=n}},jm_event_handle:function(e,t){e===n.event_type.resize&&this.resize()}};var e=new n.plugin("screenshot",function(e){var i=new n.screenshot(e);e.screenshot=i,e.shoot=function(){i.shoot()},e.add_event_listener(function(e,t){i.jm_event_handle.call(i,e,t)})});n.register_plugin(e)}}(window),function(d){var r,l,h,_,n={menuStyle:{listStyle:"none",padding:"1px",margin:"0px",backgroundColor:"#fff",border:"1px solid #999",width:"100px"},itemStyle:{margin:"0px",color:"#000",display:"block",cursor:"default",padding:"3px",border:"1px solid #fff",backgroundColor:"transparent"},itemHoverStyle:{border:"1px solid #0a246a",backgroundColor:"#b6bdd2"},eventPosX:"pageX",eventPosY:"pageY",shadow:!0,onContextMenu:null,onShowMenu:null};function u(){r.hide(),l.hide()}d.fn.contextMenu=function(e,t){r||(r=d('<div id="jqContextMenu"></div>').hide().css({position:"absolute",zIndex:"500"}).appendTo("body").bind("click",function(e){e.stopPropagation()})),l||(l=d("<div></div>").css({backgroundColor:"#000",position:"absolute",opacity:.2,zIndex:499}).appendTo("body").hide()),(_=_||[]).push({id:e,menuStyle:d.extend({},n.menuStyle,t.menuStyle||{}),itemStyle:d.extend({},n.itemStyle,t.itemStyle||{}),itemHoverStyle:d.extend({},n.itemHoverStyle,t.itemHoverStyle||{}),bindings:t.bindings||{},shadow:t.shadow||!1===t.shadow?t.shadow:n.shadow,onContextMenu:t.onContextMenu||n.onContextMenu,onShowMenu:t.onShowMenu||n.onShowMenu,eventPosX:t.eventPosX||n.eventPosX,eventPosY:t.eventPosY||n.eventPosY});var i=_.length-1;return d(this).bind("contextmenu",function(e){return(!_[i].onContextMenu||_[i].onContextMenu(e))&&function(e,i,n,t){var o=_[e];(h=d("#"+o.id).find("ul:first").clone(!0)).css(o.menuStyle).find("li").css(o.itemStyle).hover(function(){d(this).css(o.itemHoverStyle)},function(){d(this).css(o.itemStyle)}).find("img").css({verticalAlign:"middle",paddingRight:"2px"}),r.html(h),o.onShowMenu&&(r=o.onShowMenu(n,r));d.each(o.bindings,function(e,t){d("#"+e,r).bind("click",function(e){u(),t(i,n.currentTarget)})});var a=n[o.eventPosX],s=n[o.eventPosY];a+r.outerWidth()>d(document.body).width()&&(a-=r.outerWidth());s+r.outerHeight()>d(document.body).height()&&(s-=r.outerHeight());r.css({left:a,top:s}).show(),o.shadow&&l.css({width:r.width(),height:r.height(),left:a+2,top:s+2}).show();d(document).one("click",u)}(i,this,e),!1}),this},d.contextMenu={defaults:function(e){d.each(e,function(e,t){"object"==typeof t&&n[e]?d.extend(n[e],t):n[e]=t})}}}(jQuery),function(e){if(e.jsMind){var t="kmsjsmap",a="undefined"==typeof console?{log:_noop,debug:_noop,error:_noop,warn:_noop,info:_noop}:console;if(a.debug||(a.debug=_noop),"undefined"!=typeof module&&module.exports||void 0===e[t]){var s={options:"",isInit:!1,editable:!0,onRelation:_noop,init:function(e){e&&0!==Object.keys(e).length?this.isInit||(this.isInit=!0,this.options=e,this.editable=!0===e.editable,e.onRelation&&(this.onRelation=e.onRelation),this._load_jsmind(),this._init_button()):a.warn("请对"+t+".init()传入必要的参数")}},d=null;s._load_jsmind=function(){var e={container:this.options.container,editable:this.editable,theme:"kms1",mode:"full",shortcut:{enable:!1},onRelation:this.onRelation,view:{line_width:2,line_color:"#5385EE"}},t={meta:{name:"思维导图JS库",author:"Leo",version:"1.0"},format:"node_array",data:this.options.data};(d=new jsMind(e)).show(t);var i=$("<div class='lui-jsmind-innerToolBar'><ul><li class='lui_map_icon_zoom_reset mui mui-history_handler_back' title='还原' data-opt='zoomReset' ></li> <li class='lui_map_icon_zoom_in mui mui-addition' title='放大' data-opt='zoomIn'></li>  <li class='lui_map_icon_zoom_out mui mui-delete' title='缩小' data-opt='zoomOut'></li> </ul></div>");$(d.view.container).prepend(i),$(d.view.container).css("position","relative");var n=this;$(i).on("click",function(e){var t=$(e.target).attr("data-opt");t&&n[t]&&n[t]()})},s._init_button=function(){$(function(){$("jmnode").on("contextmenu",s._conTextMenuEvenHandle)})},s._conTextMenuEvenHandle=function(e){e.preventDefault(),s.editable&&$conTextMenu.show().css({left:e.pageX,top:e.pageY})},s._get_selected_nodeid=function(){var e=d.get_selected_node();return e?e.id:null},s.save=function(e){var t=d.get_data("node_array").data;e&&e(t)},s.del_node=function(){if($conTextMenu.hide(),confirm("确认删除此节点吗?")){var e=this._get_selected_nodeid();d.remove_node(e)}},s.modify_node=function(){$conTextMenu.hide();var e=d.get_selected_node();d.begin_edit(e)},s.add_node=function(){$conTextMenu.hide();var e=jsMind.util.uuid.newid(),t=d.add_node(d.get_selected_node(),e,"请输入子节点名称",{badge:0},"right");d.begin_edit(t),$("jmnode").off("contextmenu",function(){}),$("jmnode").on("contextmenu",s._conTextMenuEvenHandle)},s.relation_node=function(){$conTextMenu.hide();var e=d.get_selected_node();s.onRelation(e)},s.screenshot=function(){d.screenshot.shootDownload()},s.shootAsDataURL=function(e){d.screenshot.shootAsDataURL(e)},s.zoomIn=function(){d.view.zoomIn()},s.zoomOut=function(){d.view.zoomOut()},s.zoomReset=function(){d.view.setZoom(1)},s.fullScreen=function(e){e||(e=d.view.container);var t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullScreen;t&&t.call(e)},s.exitFullscreen=function(e){var t=document;t.webkitCancelFullScreen?t.webkitCancelFullScreen():t.mozCancelFullScreen?e.mozCancelFullScreen():t.cancelFullScreen?t.cancelFullScreen():t.exitFullscreen&&t.exitFullscreen()},s.setLinkStatus=function(e){var t=e.id,i=e.isLink;if(!t||"boolean"!=typeof i)return a.error("setLinkStatus传入参数有误");var n=$("#"+s.options.container).find('jmnode[nodeid="'+t+'"]');if(0!==!n.length){var o=d.get_selected_node();i?(n.addClass("isLink"),o.data.isLink=!0):(n.removeClass("isLink"),o.data.isLink=!1)}},e[t]=s}else a.log(t+"已经存在啦啦啦啦~")}}(window);